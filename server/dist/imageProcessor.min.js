"use strict";var _require=require("image-js"),Image=_require.Image,ndarray=require("ndarray"),ops=require("ndarray-ops"),savePixels=require("save-pixels"),split=require("split-array"),getPixels=require("get-pixels"),RUN_MODE=-1,PATH_TO_FILE="",K=-1,IMAGE=[],IMAGE_3D_MATRIX=null;function kmeans_main(e){for(var r=[],a=0;a<e.length;a++){e[a]=[Math.floor(e[a][0]),Math.floor(e[a][1])];var o=IMAGE_3D_MATRIX.get(e[a][0],e[a][1],0),n=IMAGE_3D_MATRIX.get(e[a][0],e[a][1],1),i=IMAGE_3D_MATRIX.get(e[a][0],e[a][1],2);r.push([o,n,i])}for(var t=ndarray(new Float32Array(r.flat()),[r.length,3]),s=ndarray(new Float32Array(IMAGE_3D_MATRIX.shape[0]*IMAGE_3D_MATRIX.shape[1]),[IMAGE_3D_MATRIX.shape[0],IMAGE_3D_MATRIX.shape[1]]),_=ndarray(new Float32Array(IMAGE_3D_MATRIX.shape[0]*IMAGE_3D_MATRIX.shape[1]*K),[IMAGE_3D_MATRIX.shape[0],IMAGE_3D_MATRIX.shape[1],K]),p=0;p<10;p++){for(var c=0;c<K;c++)ops.sub(_.pick(void 0,void 0,c),t.pick(void 0,void 0,0),IMAGE_3D_MATRIX.pick(void 0,void 0,0)),ops.subseq(_.pick(void 0,void 0,c),t.pick(void 0,void 0,1),IMAGE_3D_MATRIX.pick(void 0,void 0,1)),ops.subseq(_.pick(void 0,void 0,c),t.pick(void 0,void 0,2),IMAGE_3D_MATRIX.pick(void 0,void 0,2)),ops.powseq(_.pick(void 0,void 0,c),_.pick(void 0,void 0,c),2),ops.addeq(_.pick(void 0,void 0,c),_.pick(void 0,void 0,c)),ops.sqrtscaleeq(_.pick(void 0,void 0,c),_.pick(void 0,void 0,c),1);for(var v=0;v<s.shape[0];v++)for(var d=0;d<s.shape[1];d++){for(var l=Number.MAX_VALUE,A=0,I=0;I<K;I++){var M=_.get(v,d,I);M<l&&(l=M,A=I)}s.set(v,d,A)}for(var u=0;u<K;u++){for(var h=[],g=0;g<s.shape[0];g++)for(var m=0;m<s.shape[1];m++)s.get(g,m)===u&&h.push([g,m]);var R=ndarray(new Float32Array(h.flat()),[h.length,2]),f=ndarray(new Float32Array(h.length),[h.length]),E=ndarray(new Float32Array(h.length),[h.length]),k=ndarray(new Float32Array(h.length),[h.length]);ops.muleq(f,IMAGE_3D_MATRIX.pick(void 0,void 0,0),R.pick(void 0,0)),ops.muleq(E,IMAGE_3D_MATRIX.pick(void 0,void 0,1),R.pick(void 0,0)),ops.muleq(k,IMAGE_3D_MATRIX.pick(void 0,void 0,2),R.pick(void 0,0));var T=ops.sum(f),D=ops.sum(E),G=ops.sum(k);t.set(u,0,T/h.length),t.set(u,1,D/h.length),t.set(u,2,G/h.length)}}for(var X=0;X<IMAGE_3D_MATRIX.shape[0];X++)for(var y=0;y<IMAGE_3D_MATRIX.shape[1];y++){var q=s.get(X,y);IMAGE_3D_MATRIX.set(X,y,0,t.get(q,0)),IMAGE_3D_MATRIX.set(X,y,1,t.get(q,1)),IMAGE_3D_MATRIX.set(X,y,2,t.get(q,2))}}function kmeans_with_click(){var e=[];console.log("Click K times on the image to select points:");for(var r=0;r<K;r++){console.log("Click point ".concat(r+1,":"));var a=getRandomInt(0,IMAGE_3D_MATRIX.shape[0]),o=getRandomInt(0,IMAGE_3D_MATRIX.shape[1]);e.push([a,o])}kmeans_main(e)}function kmeans_with_random(){for(var e=[],r=0;r<K;r++){var a=getRandomInt(0,IMAGE_3D_MATRIX.shape[0]),o=getRandomInt(0,IMAGE_3D_MATRIX.shape[1]);e.push([a,o])}kmeans_main(e)}function read_image(){return new Promise(function(a,o){getPixels(PATH_TO_FILE,function(e,r){e&&o(e),a(r)})})}function handle_arguments(){var e=process.argv.slice(2);e.length<3&&(console.error("Usage: node color-quantization.js [Image Path] [K value] [Run Mode]"),process.exit(1)),PATH_TO_FILE=e[0],K=parseInt(e[1]),RUN_MODE=parseInt(e[2]);var r=[1,12,24];r.includes(K)||(console.error("Only K values of ".concat(r," are allowed. Your value is ").concat(K)),process.exit(1)),[0,1].includes(RUN_MODE)||(console.error("Program mode should be either 0 or 1"),process.exit(1))}function save_image(){savePixels(IMAGE_3D_MATRIX,"png").pipe(require("fs").createWriteStream("output_K".concat(K,".png"))).on("finish",function(){console.log("Success: Output file generated!"),process.exit(0)})}function getRandomInt(e,r){return Math.floor(Math.random()*(r-e+1))+e}function main(){var r,a,o,n,i,t,s;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return handle_arguments(),e.prev=1,e.next=4,regeneratorRuntime.awrap(read_image());case 4:for(r=e.sent,a=[r.shape[0],r.shape[1],3],o=new Float32Array(r.shape[0]*r.shape[1]*3),n=ndarray(o,a),i=0;i<a[0];i++)for(t=0;t<a[1];t++)for(s=0;s<a[2];s++)n.set(i,t,s,r.get(i,t,s));if(IMAGE_3D_MATRIX=n,1!==RUN_MODE){e.next=14;break}kmeans_with_random(),e.next=16;break;case 14:return e.next=16,regeneratorRuntime.awrap(kmeans_with_click());case 16:save_image(),e.next=23;break;case 19:e.prev=19,e.t0=e.catch(1),console.error(e.t0),process.exit(1);case 23:case"end":return e.stop()}},null,null,[[1,19]])}main();
//# sourceMappingURL=imageProcessor.min.js.map
